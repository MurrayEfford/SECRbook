--- 
title: "Spatially Explicit Capture--Recapture"
author: "Murray Efford"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib]
biblio-style: apalike
link-citations: yes
description: "A handbook of SECR methods."
---

<!-- omitted YAML -->
<!-- github-repo: rstudio/bookdown-demo -->

# Introduction


This book is about the methods for describing animal populations that have
come to be called 'spatially explicit capture--recapture' or simply 'spatial 
capture--recapture'. We use 'SECR' as a general label for these data and models.

SECR data are observations of marked animals at known locations. Observations result from a well-defined regime of spatial sampling, most commonly with traps, cameras, or some other type of passive detector. SECR models are used to estimate parameters of the animal population, 
particularly the population density. 

## Why SECR?

Non-spatial capture--recapture methods are highly developed and powerful [@obwa78; @wnc02; @cw]. SECR plugs some gaps in non-spatial methods (particularly with respect to density estimation), and has some unexpected benefits:

1. *Freedom from edge effects*  
Estimation of density with non-spatial capture--recapture is dogged by uncertain edge effects. SECR explicitly accounts for edge effects so density estimates are unbiased. 
2. *Reduced individual heterogeneity*  
Unmodelled individual heterogeneity of detection is a universal source of bias in capture--recapture [e.g., @lc24]. Spatial sampling is a potent source of heterogeneity, due to differential access to detectors. SECR models this component of heterogeneity, which then ceases to be a problem.
3. *Scaleable detection model*  
The core detection model in SECR describes the interaction between a single individual and a single detector. Parameter estimates can therefore be used to simulate sampling with novel detector configurations.
4. *Spatial pattern (covariates)*  
SECR allows density to be modelled as a function of continuous spatial covariates.

## Why this book?

The literature of SECR has grown beyond the attention spans and time budgets of most users.

This book provides both a gentle introduction, in the spirit of [@cw], and more in-depth treatment of important topics. It is software oriented and therefore unashamedly partial and incomplete. Much of the text is drawn from earlier documentation of R [@R-base] packages.

## Software

The R package **secr** [@R-secr] provides most of the functionality we will need. 
It performs maximum likelihood estimation for a range of closed-population SECR models[^footnote1]. 

[^footnote1]:A closed population is one in which the composition of the population and the activity distributions of individuals can be assumed fixed for the duration of sampling.

Bayesian approaches using Markov chain Monte Carlo (MCMC) methods are a flexible alternative to maximum likelihood. The R package [nimbleSCR](https://CRAN.R-project.org/package=nimbleSCR) promises to make these methods more accessible[^footnote2]. 
 
[^footnote2]: The earlier Bayesian SECR package SPACECAP [@SPACECAP] is no longer maintained and has been archived from CRAN.
 
Add-on packages extend the capability of **secr**. 

* **secrlinear** enables the estimation of linear density (e.g., animals per km) for populations in linear habitats such as stream networks ([secrlinear-vignette.pdf][]). 
* **ipsecr** fits models by simulation and inverse prediction, rather than maximum likelihood; this is a rigorous way to analyse data from single-catch traps ([ipsecr-vignette.pdf][]). 
* **secrdesign** enables the assessment of alternative study designs by  Monte Carlo simulation; scenarios may differ in detector (trap) layout, sampling intensity, and other characteristics ([secrdesign-vignette.pdf][]).
* **openCR**  [@es20] implements open-population models. 

These packages are available from the [CRAN](https://cran.r-project.org/) repository -- just open R and type `install.packages('xxxx')`.


Other R packages for SECR may be found outside CRAN. A distinct maximum-likelihood implementation due to [@srl19] is available on GitHub (https://github.com/jaroyle/oSCR). Open-population packages by Ben Augustine and Richard Glennie are also available on GitHub (https://github.com/benaug/OpenPopSCR; https://github.com/r-glennie/openpopscr). 


[secrdesign-vignette.pdf]: https://www.otago.ac.nz/density/pdfs/secrdesign-vignette.pdf
[secrlinear-vignette.pdf]: https://CRAN.R-project.org/package=secrlinear/vignettes/secrlinear-vignette.pdf
[ipsecr-vignette.pdf]: https://CRAN.R-project.org/package=ipsecr/vignettes/ipsecr-vignette.pdf

```{r eval=FALSE, echo = FALSE}
install.packages("secr")
# or the development version
# devtools::install_github("MurrayEfford/secr")
```

```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```

<!--chapter:end:index.Rmd-->

# Basics of SECR

This chapter briefly introduces the concepts and terminology of SECR. 

## Spatial population

Density is defined as the intensity of the spatial point pattern. Each point 
represents the enduring location of an animal, its activity center,
roughly speaking.

## Habitat model

## Detectors

## Detection models

In order to estimate density from a sample we must account for the sampling process. The process is inherently spatial: each animal is more likely to be detected near its activity centre, and less likely to be detected far away.  

## Data structure

## Model fitting

A SECR model combines a model for the point process (the state model) and a 
model for distance-dependent detection (the observation model). We obtain an 
unbiased estimate of population density (and other parameters) by jointly 
fitting the state and observation models.

### Methods

* simulation and inverse prediction [@edr04]
* maximum likelihood [@be08]
* MCMC with data augmentation [@ry08]
* MCMC with semi-complete data likelihood


<!--chapter:end:02-basics.rmd-->

\newcommand{\bm}[1]{\mbox{\boldmath $#1$}}

# Simple example

This vignette is a guide for those taking their first steps in fitting spatially explicit capture--recapture (SECR) models with the R package **secr** 4.6 [@R-secr]. The Alaskan snowshoe hare data of Burnham and Cushwa are used as an example. This dataset was first presented by Otis et al. (1978) and has been much used in the exploration of models for heterogeneous capture probability.

## Snowshoe hare data

\includegraphics[height=93mm,keepaspectratio=true, trim=-90 60 0 0, clip=true]{figures1/snowshoeharefromotisetal1978.pdf}  \vspace{-16pt}
\includegraphics[height=85mm,keepaspectratio=true, trim= 0 0 0 0, clip=true]{figures1/otisetal.png}

\vspace{20pt}

```{r, eval = FALSE, echo = FALSE}
knitr::include_graphics('snowshoeharefromotisetal1978.pdf')
```

\begin{quote}
"In 1972, Burnham and Cushwa (pers. comm.) laid out a livetrapping grid in a black spruce forest 30 miles (48.3 km) north of Fairbanks, Alaska. The basic grid was 10 x 10, with traps spaced 200 feet (61 m) apart. Trapping for snowshoe hares \textit{Lepus americanus} was carried out for 9 consecutive days in early winter. Traps were not baited for the first 3 days, and therefore we have chosen to analyze the data from the last 6 days of trapping."
[@obwa78, p. 36]
\end{quote} 

### Getting the data together

The raw data have been prepared as two text files[^footnote1]. They may be downloaded from https://www.otago.ac.nz/density/examples/. We assume the files are in your R working directory; use `setwd` to change that if necessary. 

The capture file "hareCH6capt.txt" has one line per capture and four columns (the header lines are commented out and are not needed). Here we display the first 6 lines. The first column is a session label derived from the original study name; it becomes significant for multi-session datasets ([secr-multisession.pdf]).

[^footnote1]: These data were provided with the CAPTURE software and have been reshaped into the standard input format for DENSITY [@density2012] and **secr** using the code in [Appendix 1](#appendix1).

```{r chunk1, ref.label="displaylines", echo=FALSE}
```
```{r capturetxt, echo = FALSE, comment = ""} 
displayLines("data1/hareCH6capt.txt", 6, "...")
```
 
\vspace{12pt}

The trap layout file "hareCH6trap.txt" has one row per trap and columns for the detector label and x- and y-coordinates. We display the first 6 lines. The detector label is used to link captures to trap sites. Coordinates can relate to any rectangular coordinate system; **secr** will assume distances are in metres. These coordinates simply describe a 10 $\times$ 10 square grid with spacing 60.96 m. Do not use unprojected geographic coordinates (latitude and longitude)[^footnote2]. 

[^footnote2]: See [secr-spatialdata.pdf].

```{r trapstxt, echo = FALSE, comment = ""} 
options(digits = 6, width = 85)       
displayLines("data1/hareCH6trap.txt", 6, "...")
```

\vspace{12pt}

We can now load **secr** and read the data files to construct a capthist object. The detectors are single-catch traps (maximum of one capture per animal per occasion and one capture per trap per occasion).

```{r setwd, echo = FALSE}
opar <- setwd('d:/density communication/book/data1')
on.exit(setwd(opar))
```

```{r readcapthist}
library(secr)
hareCH6 <- read.capthist("data1/hareCH6capt.txt", "data1/hareCH6trap.txt", detector = "single")
```

The capthist object `hareCH6` now contains almost all the information we need to fit a model. However, before launching into that it's good to take a deep breath and examine the raw data.

### Exploring the data

The data should first be summarised and plotted.
```{r summary}
summary(hareCH6)
```

The last column ('Total') is a simple sum over other columns except for M(t+1).  
The counts 'n', 'u', 'f' and 'M(t+1)' will make perfect sense if you are familiar with [@obwa78], but just in case you're not...

Table 1. Summary counts

|  Count | Description  |  
|--------|-------------------------|
|  n     | number of distinct individuals detected on each occasion $t$ |
|  u     | number of individuals detected for the first time on each occasion $t$ |
|  f     | number of individuals detected on exactly $t$ occasions |
|  M(t+1)  | cumulative number of detected individuals on each occasion $t$ |

\vspace{12pt}

The conventional summary counts are all well and good[^footnote3], but these are *spatial* data so we learn a lot by mapping them. We use the `plot` method, which for capthist objects has additional arguments; we set `tracks = TRUE` to join consecutive captures of each individual.

[^footnote3]: And the minimum sufficient statistics for the non-spatial estimators in @obwa78 are functions of these counts.

\vspace{8pt}

```{r plot, fig.width = 3.5, fig.height = 4, fig.align = "center"}
par(mar = c(1,1,3,1))  # reduce margins
plot (hareCH6, tracks = TRUE)
```

**Fig. 1.** Snowshoe hare spatial capture data plotted in **secr**. Trap sites (red crosses) are 61 m apart. Grid lines (grey) are 100 m apart (use arguments `gridl` and `gridsp` to suppress the grid or vary its spacing). Colours help distinguish individuals, but some are recycled. 

The most important insight from Fig. 1 is that individuals tend to be recaptured near their site of first capture. This is expected when the individuals of a species occupy home ranges. In SECR models the tendency for detections to be localised is reflected in the spatial scale parameter $\sigma$. Good estimation of $\sigma$ and density $D$ requires spatial recaptures (i.e. captures at sites other than the site of first capture).

Successive trap-revealed movements can be extracted with the `moves` function and summarised with `hist`:
```{r moves, fig.width = 3.5, fig.height = 2.4, fig.align = "center"}
m <- unlist(moves(hareCH6))
par(mar = c(3.2,4,1,1), mgp = c(2.1,0.6,0))  # reduce margins
hist(m, breaks = seq(-61/2, 500,61), xlab = "Movement  m", main = "")
```

**Fig. 2.** Successive trap-revealed movements of snowshoe hares on 61-m grid.

About 30% of trap-revealed movements were of $>100 \mbox{ m}$ (Fig. 2; try also `plot(ecdf(m))`), so we can be sure that peripheral hares stood a good chance of being trapped even if their home ranges were centred well outside the area plotted in Fig. 1.

The function `RPSV` with option CC = TRUE provides a biased estimate of the spatial scale $\sigma$, ignoring the problem that movements are truncated by the edge of the grid:
```{r RPSV}
initialsigma <- RPSV(hareCH6, CC = TRUE)
cat("Quick and biased estimate of sigma =", initialsigma, "m\n")
```
This estimate will be useful when we come to fit a model.

## Fitting a simple model

### Calling `secr.fit`
Next we fit the simplest possible SECR model with function `secr.fit`. Setting `trace = FALSE` suppresses printing of intermediate likelihood evaluations; it doesn't hurt to leave it out. We save the fitted model with the name 'fit'. Fitting is much faster if we use parallel processing in multiple threads - the number will depend on your machine, but 7 is OK for Windows with a quad-core processor.

```{r fit, cache = TRUE}
setNumThreads(7)  # number of cores to use 
fit <- secr.fit (hareCH6, buffer = 4 * initialsigma, trace = FALSE)
```
A warning is generated. The data are from single-catch traps, but there is no usable theory for likelihood-based estimation from single-catch traps. This is not the obstacle it might seem, because simulations seem to show that the alternative likelihood for multi-catch traps may be used without damaging the density estimates [@ebb09]. It is safe to ignore the warning for now[^footnote4]. In order to avoid the warning in later fits we reset the detector type to "multi".
```{r multi}
detector(traps(hareCH6)) <- "multi"
```

[^footnote4]: While noting that estimates of the detection parameter g0 are biased.

### Reviewing the output

The output from `secr.fit` is an object of class 'secr' (confirm this with `class(fit)`). If you investigate the structure of `fit` with `str(fit)` it will seem to be a mess: it is a list with more than 25 components, none of which contains the final estimates you are looking for. 

To examine model output or extract particular results you should use one of the functions defined for the purpose. Technically, these are S3 methods for the class 'secr'. The key methods are `print`, `plot`, `AIC`, `coef`, `vcov` and `predict`. Append '.secr' when seeking help e.g. `?print.secr`.

Typing the name of the fitted model at the R prompt invokes the print method for `secr` objects and displays a more useful report.
```{r printsecr}
fit
```

\vspace{12pt}
The report comprises these sections that you should identify:

* function call and time stamp
* summary of the data
* description of the model, including the maximized log likelihood, Akaike's Information Criterion AIC
* estimates of model coefficients (beta parameters)
* estimates of variance-covariance matrix of the coefficients
* estimates of the 'real' parameters

The last three items are generated by the `coef`, `vcov` and `predict` methods respectively. The final table of estimates is the most interesting, but it is derived from the other two. For our simple model there is one beta parameter for each real parameter[^footnote5]. The estimated density is `r round(predict(fit)['D','estimate'],2)` hares per hectare, 95% confidence interval `r paste(round(predict(fit)['D',c('lcl','ucl')],2), collapse="--")` hares per hectare[^footnote6].

[^footnote5]: We can get from beta parameter estimates to real parameter estimates by applying the inverse of the link function e.g. $\hat D = \exp(\hat \beta_D)$, and similarly for confidence limits; standard errors require a delta-method approximation (Lebreton et al. 1992).

[^footnote6]: One hectare (ha) is $10000 \mbox{ m}^2$ or $0.01 \mbox{ km}^2$.

The other two real parameters jointly determine the detection function that you can easily plot with 95% confidence limits:
```{r plotfit, fig.width=3.5, fig.height=3.5, fig.align="center"}
par(mar = c(4,4,1,1))  # reduce margins
plot(fit, limits = TRUE)
```


### Choosing the buffer width {#choosebuffer}

When fitting the simple model with `secr.fit` we used `buffer = 4 * initialsigma` without any explanation. Here it is. As far as we know, the snowshow hare traps were surrounded by suitable habitat. We limit our attention to the area immediately around the traps by specifying a habitat buffer. The `buffer` argument is a short-cut method for defining the area of integration; the alternative is to provide a habitat mask in the `mask` argument. Buffers and habitat masks are covered at length in [secr-habitatmasks.pdf].

The theory of SECR tells us that buffer width is not critical as long as it is wide enough that animals at the edge have effectively zero chance of appearing in our sample. The $4\sigma$ suggestion is based on experience with half-normal detection models[^footnote7]. We check that for the present model with the function `esa.plot`. The estimated density[^footnote8] has easily reached a plateau at the chosen buffer width (dashed red line):

[^footnote7]: This is not just the tail probability of a normal deviate; think about how the probability of an individual being detected at least once changes with (i) the duration of sampling (ii) the density of detector array.

[^footnote8]: These are Horvitz-Thompson-like estimates of density obtained by dividing the observed number of individuals $n$ by effective sampling areas [@be08] computed as the cumulative sum over mask cells ordered by distance from the traps. The algorithm treats the detection parameters as known and fixed.

```{r esaplot, fig.width = 3.5, fig.height = 3.5, fig.align = "center"}
esa.plot(fit)
abline(v = 4 * initialsigma, lty = 2, col = 'red')
```

### Choosing a detection function

* detection probability declines with distance according to a half-normal curve

We can try alternative shapes for the detection function (the decline in detection probability with distance). 

**secr** offers several different shapes of detection function (see the list at `?detectfn`). We need to sort these out. All except ANN and HAN decline monotonically with distance. Three are only used for acoustic data (BSS, SS, SSS). The simplest UN is not available for maximum likelihood model fitting, and several are frankly exotic and almost never used (CHN, WEX, CLN, CG), as are ANN and HAN.

That leaves the half-normal, negative exponential, and hazard rate functions (HN, EX, HR) These differ primarily in the length of their tails i.e. the probability they assign to very distant detections. The half-normal makes distant detections very improbable, the negative exponential less so; The 'hazard-rate' function requires a third parameter and potentially has a very long tail indeed.

Fit each of these and assess the effect. We use a wider buffer to allow for longer tails.

```{r detectfn, cache = TRUE}
fit.HN <- secr.fit (hareCH6, buffer = 6 * initialsigma, detectfn = 'HN', trace = FALSE)
fit.EX <- secr.fit (hareCH6, buffer = 6 * initialsigma, detectfn = 'EX', trace = FALSE)
fit.HR <- secr.fit (hareCH6, buffer = 6 * initialsigma, detectfn = 'HR', trace = FALSE)
```

How do the models compare? The last one (fit.HR) raised a warning from the post-fitting bias check that we discuss more below. We bundle the fits together in an object of class secrlist -- this is simply a convenience -- and then inspect the estimates:

```{r comparedf}
fits <- secrlist(HN = fit.HN, EX = fit.EX, HR = fit.HR) 
predict(fits)
```

Note how similar the density estimates are from HN and EX; HR not so much. The parameter named 'sigma' means a different thing for each function, so do not compare. To my mind this also applies to the function-specific 'g0'.

Formal model comparison by AIC places the longer-tailed functions EX and HR ahead of HN:
```{r AICdetectfn}
AIC(fits)
```

The selection of HR is a worry because it has some annoying properties as we can see on this plot:
```{r esaplots, fig.width = 4.5, fig.height = 4, fig.align = "center"}
par(mar = c(4,4,2,2))
esa.plot(fits, max.buffer = 6 * initialsigma) 
```

Although the density estimates from HN and EX reach a plateau fairly promptly with increasing buffer width, the estimates from HR do not. That means that estimates of density remain sensitive to buffer width out to quite large distances. The sensitivity explains why the bias check raised a warning. It is an argument for not using HR except where there is a natural boundary (check out habitat islands in [secr-habitatmasks.pdf]). There is an unresolved research question here: Do real animals have such long tails?

Provisionally rejecting HR, we are left with EX as the preferred model for these data. HN delivers essentially the same estimate of density.

## The `model` argument of `secr.fit`

Our initial model assumed that the detection of all individuals is governed by the same detection vs distance curve at all detectors on all occasions. The 'model' argument of `secr.fit` allows this assumption to be relaxed in particular ways.

Although this is a longish section, and one that can occupy a lot of time, be warned that the returns from exhaustively pursuing the last sliver of improvement in fit are usually trivial. We rely on the robustness of SECR models. The potential effects of most importance are learned responses and individual heterogeneity.

The 'model' argument allows us to specify variation in each of the 'real' parameters (i.e. density D and the detection parameters g0 [^footnote9] and sigma). In the default model each real parameter is constant (D ~ 1, g0 ~ 1, sigma ~ 1), but the constant indicator '1' in each formula may be replaced by a predictor, or perhaps a combination of predictors. We focus on the detection parameters. The predictor may be 

* a code for an automatically generated predictor, or
* the name of an individual, trap or session covariate. 

[^footnote9]: For some detection functions g0 is replaced by lambda0

Codes for automatically generated predictors are listed on the help page `?"secr detection models"`, and we show a subset in Table 2. The most important in terms of an effect on estimates of density are those for learned responses and unmodelled individual heterogeneity. Heterogeneity raises multiple issues that we do not have space for here. We concentrate on learned responses.

\vspace{12pt}

Table 2. Automatic predictors commonly used to model detection parameters.

|  Code | Description  |  
|--------|-------------------------|
| b     | permanent global learned response |
| bk    | permanent detector-specific learned response |
| t      | time factor (one level for each occasion) |
| T      | time trend (integer covariate 0:(S-1)) |
| g      | group (as specified by 'groups' argument) |
| h2      | 2-class finite mixture |
| session | session factor (one level for each session) |

\vspace{8pt}

### Learned responses

@obwa78 considered the possibility that the experience of capture induced a change in the probability of capturing an individual on any later occasion. They called this a 'behavioral response', and henceforth it has been labelled 'b'. The model envisaged a permanent step change in behaviour 

Spatial models may include more subtle effects. Most importantly, the learned response may be specific to the detector location (code bk), rather than applying generally across all detectors (code b).

We consider the possibility of either sort of learned response in snowshoe hares:

```{r learned response, cache = TRUE}
fit.EXb <- secr.fit (hareCH6, buffer = 6 * initialsigma, detectfn = 'EX', 
                    model = g0 ~ b, trace = FALSE)
fit.EXbk <- secr.fit (hareCH6, buffer = 6 * initialsigma, detectfn = 'EX', 
                      model = g0 ~ bk, trace = FALSE)
```

For convenience we bundle the original (null) model and the two new models together in one object of class 'secrlist'. That may be passed as a unit to other functions, particularly AIC:

```{r fitsb, cache = TRUE}
fitsb <- secrlist(null = fits$EX, b = fit.EXb, bk = fit.EXbk)
AIC(fitsb)
predict(fitsb)
```

The global response model b comes out on top. However, the AIC differences among the three models (b, bk, null) are very small. This would not be a problem, except that the density estimate from model b is noticeably larger than the others, so it does matter which we choose. 
The learned response may be positive or negative. The direction can be determined by the sign of the relevant coefficient (g0.bTRUE) in `coef(fitsb$b)`. The coefficient is 
`r round(coef(fitsb$b)['g0.bTRUE','beta'],2)`
(95% CI `r paste(round(coef(fitsb$b)['g0.bTRUE',c('lcl','ucl')],2), collapse=' -- ')`), remembering that this relates to the link (logit) scale.

### Results for predictor levels other than the base level

The default output from `predict` for estimates of the 'real' parameters is incomplete: it shows only the value of g0 for a naive animal (b = 0). To see the estimates for both b = 0 and b = 1, and hence the magnitude of the effect on the probability scale, we specify the 'newdata' argument of the `predict` method:[^footnote10]

\vspace{8pt}

```{r bchange}
predict(fitsb$b, newdata = data.frame(b = 0:1), realnames = "g0")   
```

[^footnote10]: We also use the new argument 'realnames' to select only the parameter we want.

It will usually be necessary to specify 'newdata' like this to obtain the predicted values of real parameters at different levels of the predictors. `expand.grid` is a handy alternative to `data.frame` if you want to see all combinations of predictors.

### Model averaging

One way to duck the problem of selecting a single model is to average over the models using AIC or AICc model weights. There is a function for this:

```{r modelaverage}
modelAverage(fitsb, criterion = 'AICc')
```

Our model-informed 'best guess' of the density comes out at 
`r round(modelAverage(fitsb)['D','estimate'],2)` hares per hectare 
with 95% confidence interval 
`r paste(round(modelAverage(fitsb)['D',c('lcl','ucl')],2), collapse = "--")`
 hares per hectare.
 
<!-- ```{r derived, cache = TRUE} -->
<!-- derived(fitsb) -->
<!-- ``` -->

<!-- Compare model selection with CAPTURE, MARK -->

<!-- ## Unmodelled heterogeneity -->

<!-- ## Sex-specific models -->

<!-- # Modelling density -->
<!-- ## Temporal -->
<!-- ## Spatial -->

\pagebreak

## Appendix 1. Conversion of snowshoe hare data from CAPTURE format. {#appendix1}

First define a function to peek at text files:
```{r displaylines}
displayLines <- function(filename, nlines, final = "") {
    con <- file(filename)
    cat(readLines(con,nlines), sep='\n')
    if (final != "") cat(final, "\n")
    close(con)
}
```

```{r loadsecr, message = FALSE, warning = FALSE}
library(secr)
workdir <- 'd:/density secr 4.6/package data/snowshoehares/'
inpfile <- paste0(workdir, 'hares.txt')
# check raw data
displayLines(inpfile, 9)
```

```{r}
# read raw data, skipping 3 header lines, and shape into a dataframe with one row 
# per capture
tmp <- read.fortran(inpfile, format = c('A29','4X', 'A2','5X','9A4'), skip = 3)
capt <- data.frame(session = rep(tmp[,1], each = 9), 
                   ID = rep(tmp[,2], each=9), 
                   occasion = rep(1:9, nrow(tmp)), 
                   trapID = as.character(t(tmp[,3:11])),
                   stringsAsFactors = FALSE)
# drop non-captures
capt <- capt[capt$trapID!= ' 0 0',]
# recode blanks to zero in trapID, 
capt$trapID <- gsub(' ','0', capt$trapID)
# view first 6 captures (ordered by animal)
head(capt)
```

```{r makeCH, eval = FALSE}
# make trapping grid object
grid <- make.grid(nx = 10, ny = 10, spacing = 60.96, detector = 'single', ID = 'xy')
# construct capthist object
hareCH <- make.capthist(capt, grid)
# restrict to last 6 days
hareCH6 <- subset(hareCH, occasions = 4:9)
write.capthist(hareCH6)
```

[snowshoehare]: snowshoeharefromotisetal1978.pdf 
[otisetal]: otisetal.png
[secr-datainput.pdf]: https://www.otago.ac.nz/density/pdfs/secr-datainput.pdf
[secr-overview.pdf]: https://www.otago.ac.nz/density/pdfs/secr-overview.pdf

[density surfaces]: https://www.otago.ac.nz/density/pdfs/secr-densitysurfaces.pdf
[secr-densitysurfaces.pdf]: https://www.otago.ac.nz/density/pdfs/secr-densitysurfaces.pdf
[secr-habitatmasks.pdf]: https://www.otago.ac.nz/density/pdfs/secr-habitatmasks.pdf
[secr-multisession.pdf]: https://www.otago.ac.nz/density/pdfs/secr-multisession.pdf
[secr-noneuclidean.pdf]: https://www.otago.ac.nz/density/pdfs/secr-noneuclidean.pdf
[secr-spatialdata.pdf]: https://www.otago.ac.nz/density/pdfs/secr-spatialdata.pdf

<!--chapter:end:03-example.Rmd-->

# Simulation

## Population

`sim.popn`

## Detection

`sim.capthist`

## **secrdesign**

<!--chapter:end:08-simulation.rmd-->

`r if (knitr:::is_html_output()) '
# References {-}
'`

<!--chapter:end:99-references.Rmd-->

